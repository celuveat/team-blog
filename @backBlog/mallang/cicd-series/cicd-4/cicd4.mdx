---
date: 2023-08-09
authors: shin-mallang
title: "ì…€ëŸ½ì‡ CI/CD ë°œì „ê¸° - (4) CD ì†ë„ í–¥ìƒê¸°"
description: "ì…€ëŸ½ì‡ íŒ€ì˜ CI/CD ë°œì „ê¸°"
keywords: ["CI/CD", "ì¸í”„ë¼"]
tags:
  - CI/CD
  - ì¸í”„ë¼
  - Github Actions
  - docker
---

ì…€ëŸ½ì‡ CI/CD ë°œì „ê¸° - (4) CD ì†ë„ í–¥ìƒê¸°

<!--truncate-->

<br />
<br />

## ğŸ§ ì„œë¡ 

ì•ˆë…•í•˜ì„¸ìš”. ì…€ëŸ½ì‡ì˜ ë°±ì—”ë“œ ë§ë‘ì…ë‹ˆë‹¤.

ì €í¬ëŠ” github actionsì™€ dockerë¥¼ ì‚¬ìš©í•˜ì—¬ CD ì›Œí¬í”Œë¡œìš°ë¥¼ êµ¬ì„±í•˜ì˜€ëŠ”ë°ìš”,
í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ê°€ í•œ ë²ˆ ì‹¤í–‰ë  ë•Œë§ˆë‹¤ 1ë¶„ ì´ìƒì˜ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì„ í™•ì¸í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.

ë¬¼ë¡  ì–´ë–»ê²Œ ë³´ë©´ ê·¸ë¦¬ ê¸´ ì‹œê°„ì€ ì•„ë‹ ìˆ˜ ìˆì§€ë§Œ, ê·¸ë˜ë„ ë¹ ë¥´ë©´ ë¹ ë¥¼ìˆ˜ë¡ ì¢‹ì–ì•„ìš”?

ê·¸ë˜ì„œ ì´ë²ˆ ê¸€ì—ì„œëŠ” CD ì›Œí¬í”Œë¡œìš°ì˜ ì†ë„ë¥¼ í–¥ìƒì‹œì¼œë³´ëŠ” ì‹œê°„ì„ ê°€ì§€ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br />
<br />
<br />
<br />
<br />
<br />

## ğŸ§Gradle Caching

í˜„ì¬ github actionsì˜ workflowê°€ (jar íŒŒì¼ì˜ ë³€ê²½ ì—†ì´) ì „ì²´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![no-caching-1](./no-caching-1.png)
![no-caching-2](./no-caching-2.png)
![no-caching-3](./no-caching-3.png)
![no-caching-4](./no-caching-4.png)

í‰ê· ì ìœ¼ë¡œ 1ë¶„ 10ì´ˆ ì •ë„ì˜ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ì¤„ì´ê¸° ìœ„í•´ Gradle Cachingì„ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>

### ğŸš€ Gradle Cachingì´ë€?
(ì°¸ê³  - [ê³µì‹ë¬¸ì„œ](https://docs.gradle.org/current/userguide/core_dependency_management.html#sec:dependency-mgmt-in-gradle))<br/>
Gradleì€ ë¹Œë“œ ì‹œì— ì‘ì—…(Task)ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤ì„ ëª¨ë‘ ê°€ì ¸ì˜¨ ë’¤, ì´ë“¤ì„ dependency cacheë¼ ë¶ˆë¦¬ëŠ” ë¡œì»¬ ìºì‹œì— ë³´ê´€í•˜ì—¬
ì´í›„ í˜¸ì¶œì—ì„œ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì„ ë°©ì§€í•˜ëŠ” ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ Github Actionsì˜ workflowì—ì„œëŠ” ë§¤ ì‹¤í–‰ë§ˆë‹¤ ìƒˆë¡­ê²Œ ì˜ì¡´ì„±ë“¤ì„ ê°€ì§€ê³  ì˜¤ê²Œ ë©ë‹ˆë‹¤.<br/>
ì˜ì¡´ì„±ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ëŒ€ì²´ë¡œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, í•´ë‹¹ ê³¼ì •ì´ ì—†ì–´ì§„ë‹¤ë©´ ì „ì²´ ë¹Œë“œ ì‹œê°„ì´ ë§¤ìš° ë‹¨ì¶•ë  ê²ƒì´ë¼ ì˜ˆìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•œë²ˆ Gradle Cachingì„ ì ìš©í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒì´ ì–¼ë§ˆë‚˜ ì´ë£¨ì–´ì§€ëŠ”ì§€ í™•ì¸í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
ë°©ë²•ì€ ë§¤ìš° ê°„ë‹¨í•©ë‹ˆë‹¤.
```yml
- name: âœ¨ Gradle Caching
  uses: actions/cache@v3
  with:
    path: |
        ~/.gradle/caches
        ~/.gradle/wrapper
    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
    restore-keys: |
        ${{ runner.os }}-gradle-
```

ìœ„ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ë©´ ë˜ëŠ”ë°ìš”, ì´ë¥¼ ì ìš©í•œ ì „ì²´ workflowëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<br/>
<br/>

```yml
name: âœ¨ Celuveat backend PROD CD âœ¨

env:
  PROFILE: prod
  IMAGE_TAG: prod-${{ secrets.APP_VERSION_TAG }}
  DOCKER_CONTAINER_NAME: backend
  DOCKER_HUB_REPOSITORY: celuveat/celuveat

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  backend-docker-build-and-push:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: âœ¨ Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.ACTION_TOKEN }}

      - name: âœ¨ JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âœ¨ Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
              ${{ runner.os }}-gradle-

      - name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
        run: ./gradlew bootJar

      - name: âœ¨ DockerHubì— ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/arm64
          tags: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}

  backend-docker-pull-and-run:
    runs-on: [self-hosted, prod]
    if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
    needs: [ backend-docker-build-and-push ]
    steps:
      - name: âœ¨ DockerHubì—ì„œ Image Pull
        run: |
          docker login --username ${{ secrets.DOCKERHUB_USERNAME }} --password ${{ secrets.DOCKERHUB_PASSWORD }}
          docker pull ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker stop ${{ env.DOCKER_CONTAINER_NAME }} || true
          docker container prune -f
          docker image prune -f

      - name: âœ¨ Docker Image ì‹¤í–‰
        run: |
          docker run \
            -d \
            --name ${{ env.DOCKER_CONTAINER_NAME }} \
            -p 8080:8080 \
            -e "SPRING_PROFILES_ACTIVE=${{ env.PROFILE }}" \
            ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}
```

<br/>
<br/>

ìºì‹±ì„ ì ìš©í•œ github actionsì˜ workflowê°€ (jar íŒŒì¼ì˜ ë³€ê²½ ì—†ì´) ì „ì²´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

#### ì²« ì‹¤í–‰
![yes-caching-1](./yes-caching-1.png)

#### ì´í›„ ì‹¤í–‰
![yes-caching-2](./yes-caching-2.png)
![yes-caching-3](./yes-caching-3.png)
![yes-caching-4](./yes-caching-4.png)
![yes-caching-5](./yes-caching-5.png)

<br/>

ê°„ë‹¨í•œ ê·¸ë˜ì´ë“¤ ìºì‹±ë§Œìœ¼ë¡œë„ (ì²« ì‹¤í–‰ ì œì™¸) ì„±ëŠ¥ì´ ëŒ€ëµ 25%ì •ë„ í–¥ìƒëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

## ğŸ§Docker Layer Caching
### ğŸš€ Docker Layerë€?
ë„ì»¤ ì´ë¯¸ì§€ëŠ” ë¹Œë“œ ì‹œ Dockerfileì— ì íŒ ëª…ë ¹ì–´ë“¤ì„ ì‹¤í–‰í•˜ë©° ì°¨ë¡€ë¡œ ë ˆì´ì–´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
ì´ë•Œ RUN, ADD, COPYë¡œ ìƒì„±ë˜ëŠ” ë ˆì´ì–´ëŠ” íŒŒì¼ì˜ ìš©ëŸ‰ì„ ì»¤ì§€ê²Œ ë§Œë“¤ê³ , ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ëŠ” ì‹œê°„ë„ ê¸¸ì–´ì§€ê²Œ í•©ë‹ˆë‹¤.

<br/>

### ğŸš€ Docker Layer Caching
ë„ì»¤ëŠ” ë¹Œë“œë¥¼ ì‹¤í–‰í•  ë•Œ ì´ì „ ë¹Œë“œì˜ ë ˆì´ì–´ë¥¼ ì¬ì‚¬ìš©í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤.
ë ˆì´ì–´ê°€ ë³€ê²½ë˜ì§€ ì•Šì€ ê²½ìš°, ì´ì „ ë¹Œë“œì˜ ë ˆì´ì–´ë¥¼ ì¬ì‚¬ìš©í•¨ìœ¼ë¡œì¨ ë¹Œë“œ ì‹œê°„ì„ ë‹¨ì¶•ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ê·¸ë¦¬ê³  ì´ëŠ” ë„ì»¤ì˜ ì´ë¯¸ì§€ ë¹Œë”ê°€ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•´ì¤ë‹ˆë‹¤.

<br/>

### ğŸš€ Github Actionsì—ì„œì˜ Docker Layer Caching
Github Actionsì˜ ëŸ¬ë„ˆëŠ” ë§¤ë²ˆ ìƒˆë¡œìš´ ê°€ìƒ í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.<br/>
ë”°ë¼ì„œ ë¹Œë“œë¥¼ ì—¬ëŸ¬ë²ˆ ìˆ˜í–‰í•˜ë”ë¼ë„ ìºì‹œë˜ì§€ ì•Šê³  ë§¤ë²ˆ ìƒˆë¡­ê²Œ ìˆ˜í–‰ë©ë‹ˆë‹¤.
ê·¸ë˜ì„œ ê·¸ë˜ì´ë“¤ ìºì‹± ë¶€ë¶„ì—ì„œ ì‚´í´ë³´ì•˜ë˜ ê²ƒê³¼ ê°™ì´ Github Actionsì—ì„œ ìºì‹±ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ([ë³„ë„ì˜ ì„¤ì •](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows))ì„ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

<br/>

Docker Layer Cachingì˜ ê²½ìš°, í˜„ì¬ ì €í¬ê°€ ì‚¬ìš©í•˜ëŠ” actionsì¸ [`docker/build-push-action@v4`](https://github.com/docker/build-push-action/tree/master)ì—ì„œ í¸í•˜ê²Œ ì„¤ì •í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•´ì£¼ê³  ìˆìŠµë‹ˆë‹¤.

ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```yml
- name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
  uses: docker/build-push-action@v4
  with:
    context: ./backend
    file: ./backend/Dockerfile
    push: true
    platforms: linux/arm64
    tags: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}
    cache-from: type=gha
    cache-to: type=gha,mode=max
```
- `cache-from`ê³¼ `cache-to` ë¶€ë¶„ì„ ì¶”ê°€í•´ì£¼ì—ˆê³ , í”„ë¡ íŠ¸ ì—­ì‹œ ë™ì¼í•˜ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
([ì°¸ê³ ](https://docs.docker.com/build/ci/github-actions/cache/#github-cache))

<br/>
<br/>


### ğŸš€ ì‹œê°„ ë¹„êµ

#### ë°±ì—”ë“œ ì²« ì‹¤í–‰

<br/>
<br/>

#### ë°±ì—”ë“œ ì´í›„ ì‹¤í–‰

<br/>
<br/>

#### í”„ë¡ íŠ¸ ì²« ì‹¤í–‰

<br/>
<br/>

#### í”„ë¡ íŠ¸ ì´í›„ ì‹¤í–‰


<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

## ğŸ§ Jar íŒŒì¼ Bind Mount
### ğŸš€ Bind Mountë€?
([ê³µì‹ë¬¸ì„œ](https://docs.docker.com/storage/bind-mounts/))<br/>
Bind MountëŠ” ì‰½ê²Œ ë§í•´ì„œ í˜¸ìŠ¤íŠ¸ ë¨¸ì‹ ì˜ íŒŒì¼ì„ ë„ì»¤ì™€ ì—°ê²°í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ ë„ì»¤ ë‚´ë¶€ì—ì„œ ìƒì„±í•˜ëŠ” íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì—ì„œë„ ë³¼ ìˆ˜ ìˆê³ ,
ë˜í•œ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì˜ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.


<br/>
<br/>

### ğŸš€ Jar íŒŒì¼ Bind Mountë¥¼ í†µí•œ ì„±ëŠ¥ í–¥ìƒ
í˜„ì¬ ë°±ì—”ë“œì˜ Dockerfileì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```dockerfile
FROM amazoncorretto:17-alpine-jdk

WORKDIR /app

COPY ./build/libs/celuveat-0.0.1-SNAPSHOT.jar /app/celuveat.jar

CMD ["java", "-jar", "celuveat.jar"]
```

ì´ë•Œ COPY ëª…ë ¹ì–´ê°€ ì‚¬ìš©ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œê°€ ë³€ê²½ë˜ì–´ jar íŒŒì¼ì´ ìƒˆë¡­ê²Œ ë¹Œë“œëœ ê²½ìš°, ì´ë¡œ ì¸í•´ ì´ë¯¸ì§€ë¥¼ ìƒˆë¡œ ë¹Œë“œí•´ì•¼ í•˜ëŠ” ìƒí™©ì´ ë°œìƒí•©ë‹ˆë‹¤.<br/>
ê·¸ëŸ¬ë‚˜ ì‚¬ì‹¤ ìœ„ Dockerfileì„ JaríŒŒì¼ì„ Copyí•˜ëŠ” ë¶€ë¶„ì„ ì œì™¸í•˜ë©´ ê±°ì˜ ë³€ê²½ë  ì¼ì´ ì—†ëŠ” ì´ë¯¸ì§€ì…ë‹ˆë‹¤.<br/>
ì¦‰ JaríŒŒì¼ë§Œ ë”°ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤ë©´ ìºì‹±ì„ í†µí•´ ì„±ëŠ¥ì„ í–¥ìƒí•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.


ê·¸ë˜ì„œ ë‹¤ìŒê³¼ ê°™ì€ ë°©ë²•ì„ í†µí•´ ì„±ëŠ¥ì„ í–¥ìƒì‹œì¼œë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
1. DockerFileì—ì„œ Copy ë¶€ë¶„ì„ ì œê±°í•œë‹¤
2. jaríŒŒì¼ ë¹Œë“œ í›„, ì´ë¥¼ SCPë¥¼ í†µí•´ EC2ë¡œ ë„˜ê²¨ì¤€ë‹¤.
3. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ jar íŒŒì¼ì„ bind mountë¡œ ì—°ê²°í•˜ì—¬ ì‹¤í–‰í•œë‹¤.


<br/>
<br/>


<br/>
<br/>

