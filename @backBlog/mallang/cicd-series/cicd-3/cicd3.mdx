---
date: 2023-08-07
authors: shin-mallang
title: "ì…€ëŸ½ì‡ CI/CD ë°œì „ê¸° - (3-1) ë°±ì—”ë“œì˜ dockerì™€ github actionsë¥¼ í†µí•œ ë°°í¬ ìë™í™”"
description: "ì…€ëŸ½ì‡ íŒ€ì˜ CI/CD ë°œì „ê¸°"
keywords: ["CI/CD", "ì¸í”„ë¼"]
tags:
  - CI/CD
  - ì¸í”„ë¼
  - Github Actions
  - docker
---

ì…€ëŸ½ì‡ CI/CD ë°œì „ê¸° - (3-1) ë°±ì—”ë“œì˜ dockerì™€ github actionsë¥¼ í†µí•œ ë°°í¬ ìë™í™”

<!--truncate-->

<br />
<br />
<br />

## ğŸ§ ì„œë¡ 

ì•ˆë…•í•˜ì„¸ìš”. ì…€ëŸ½ì‡ì˜ ë°±ì—”ë“œ ë§ë‘ì…ë‹ˆë‹¤.

ë‹¤ë¥¸ íŒ€ë“¤ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ì…€ëŸ½ì‡ íŒ€ë„ ì§€ë‚œì£¼ì— ì‹¤ì œ ì„œë²„ì— ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í–ˆëŠ”ë°ìš”, ê·¸ ê³¼ì •ì—ì„œ ì„œë²„ê°€ ê±°ì˜ ì£½ì–´ê°€ëŠ” ìƒí™©ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤ ğŸ˜¢

![front](./front-build.png)

ê·¸ ë‹¹ì‹œ ì„œë²„ì˜ ì—¬ìœ  ë©”ëª¨ë¦¬ë¥¼ í™•ì¸í•´ë³´ë‹ˆ ì´ë¯¸ `Swap Memory`ë¥¼ `2GB` ì“°ê³  ìˆëŠ” ìƒí™©ì´ì—ˆìŒì—ë„ `20~50mb` ì •ë„ë°–ì— ë‚¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

ì´ ë¬¸ì œëŠ” ì¼ì‹œì ìœ¼ë¡œ ë°œìƒí–ˆì–´ì„œ ì§€ê¸ˆ ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ë©´ ìµœì†Œ 500Mb ì •ë„ì˜ ì—¬ìœ  ë©”ëª¨ë¦¬ê°€ ë‚¨ê²Œ ë˜ëŠ”ë°ìš”, <br/>
ì§€ê¸ˆ ë‹¹ì¥ì€ ë¬¸ì œê°€ ë˜ì§€ ì•Šë”ë¼ë„ ì–¸ì  ê°€ëŠ” ë¬¸ì œê°€ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì´ë¥¼ í•´ê²°í•´ë³´ë ¤ í•©ë‹ˆë‹¤.


<br />
<br />
<br />
<br />
<br />

## ğŸ§ í•´ê²° ë°©ë²• ìƒê°í•˜ê¸°
ê°€ì¥ ê°„ë‹¨íˆ ìƒê°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ìœ¼ë¡œëŠ” `Swap Memory`ë¥¼ ë” ë§ì´ í• ë‹¹í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë‹¤ìŒ [RedHatì˜ ë¬¸ì„œ](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/managing_storage_devices/getting-started-with-swap_managing-storage-devices#recommended-system-swap-space_getting-started-with-swap)ì— ë”°ë¼
ì„œë²„ì˜ RAMì´ 2GiBì¸ ì €í¬ëŠ” 2ë°°ì¸ 4GB ì •ë„ë¥¼ í• ë‹¹í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì¥ ë¬´ë‚œí•˜ê²Œ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ë„ 20GBë¥¼ í• ë‹¹í•˜ì—¬ ì‚¬ìš©í•˜ê³  ìˆìœ¼ë¯€ë¡œ, 4GBì˜ Swap Memoryë¡œ ì¸í•´ ë¬¸ì œê°€ ìƒê¸¸ ê²ƒì´ë¼ê³ ëŠ” íŒë‹¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ìœ„ ë°©ë²•ìœ¼ë¡œ í•´ê²°í•˜ëŠ” ê²ƒì´ ê°€ì¥ ê°„ë‹¨í•˜ê² ì§€ë§Œ, ì´ì™• ë¬¸ì œê°€ ë°œìƒí•œê¹€ì— ê¸°ì¡´ì— ë¶ˆí¸í•˜ë‹¤ê³  ëŠê¼ˆë˜ ë¶€ë¶„ë“¤ë„ ëª¨ë‘ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

<br />
<br />
<br />
<br />
<br />


## ğŸ§ ì¶”ê°€ì ì¸ ë¶ˆí¸ ì‚¬í•­
(ì ˆëŒ€ ë„ì»¤ ì“°ê³ ì‹¶ì–´ì„œ ëŠë¼ëŠ” ì–µì§€ ë¶ˆí¸í•¨ì´ ì•„ë‹˜ì„ ë°í™ë‹ˆë‹¤)

ì…€ëŸ½ì‡ì€ ë°°í¬ ìë™í™”ë¥¼ ìœ„í•´ í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œë³„ë¡œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“¤ì–´ë‘” í›„,
Github Actionsì˜ Self Hosted Runnerë¥¼ í†µí•´ ê° ì„œë²„ì˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ìœ„í•´ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì‚¬ì „ ì‘ì—…ì´ í•„ìš”í•©ë‹ˆë‹¤.
 1. ê° ì„œë²„(dev, prod)ì— `java`ì™€ `yarn`, `node` ë“± í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ í™˜ê²½ì´ ë¯¸ë¦¬ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
 2. ê° ì„œë²„ì— í•„ìš”í•œ `ë°°í¬ ìŠ¤í¬ë¦½íŠ¸`ë¥¼ ë¯¸ë¦¬ ì‘ì„±í•´ì„œ ë„£ì–´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
 3. ë°°í¬ ê³¼ì •ì— ë³€ê²½ ì‚¬í•­ì´ ìƒê¸´ë‹¤ë©´ ê° ì„œë²„ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ `ë™ì¼í•˜ê²Œ ë³€ê²½`í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

ìœ„ëŠ” ëª¨ë‘ ë‹¤ ì…€ëŸ½ì‡ íŒ€ì´ ë°°í¬ë¥¼ ì§„í–‰í•˜ë©° ê²ªì—ˆë˜ ì–´ë ¤ì›€ê³¼ ê·€ì°®ìŒì´ë©°,
ë¬´ì—‡ë³´ë‹¤ ë¬¸ì œì¸ ì ì€ `ìš°í…Œì½” êµìœ¡ì¥ ë‚´ì—ì„œë§Œ EC2ì— ssh ë¡œ ì ‘ê·¼`í•  ìˆ˜ ìˆê¸°ì— ìœ„ 3ê°œì˜ ì‘ì—… ëª¨ë‘
í‡´ê·¼í•œ ë’¤ ì§‘ì—ì„œëŠ” ìˆ˜í–‰í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

<br/>
<br/>

ìš°í…Œì½”ê°€ ëë‚œ ë’¤ í”„ë¡œì íŠ¸ë¥¼ ì§€ì†í•˜ê¸° ìœ„í•´ ì„œë²„ë¥¼ ë”°ë¡œ ì‚¬ìš©í•  ê²½ìš°ì—ë„ ìœ„ì™€ ê°™ì€ ì„¤ì •ì„ ë˜ ì§„í–‰í•´ ì£¼ì–´ì•¼ í•˜ëŠ”ë°ìš”,
ìƒìƒë§Œ í•´ë„ ë„ˆë¬´ ê·€ì°®ì€ ë‚˜ë¨¸ì§€ ì´ëŸ¬í•œ ë¶ˆí¸í•¨ì„ í•´ì†Œí•˜ê³ ì `ğŸ³ Docker`ë¥¼ ë„ì…í•˜ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.


<br/>
<br/>
<br/>
<br/>
<br/>


## ğŸ§ Dockerë¥¼ ì‚¬ìš©í•œ CD ì•„í‚¤í…ì²˜
ì´ë²ˆì— êµ¬ì„±í•œ CD ì•„í‚¤í…ì²˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
![cicd](./cicd3.png)

ì „ì²´ì ì¸ FlowëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
 1. main ë¸Œëœì¹˜ì— prì— mergeë˜ëŠ” ìˆœê°„ github actionsì˜ CD workflowê°€ ë™ì‘í•©ë‹ˆë‹¤.
 2. workflowì—ì„œëŠ” DockerFileì„ í†µí•´ react í˜¹ì€ spring ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•œ ë’¤ DockerHubì— Pushí•©ë‹ˆë‹¤.
 3. ì´í›„ EC2ì˜ self hosted runnersë¥¼ ë™ì‘ì‹œì¼œ DockerHubì—ì„œ DockerFileì„ Pull ë°›ìŠµë‹ˆë‹¤.
 4. Pull ë°›ì€ DockerFileì„ ì‹¤í–‰ì‹œí‚µë‹ˆë‹¤.

ì´ì œë¶€í„° ìœ„ ì•„í‚¤í…ì²˜ë¥¼ ì°¨ê·¼ì°¨ê·¼ êµ¬ì„±í•´ ë‚˜ê°€ë„ë¡ í• í…ë°ìš”, ê·¸ ì „ì— Dockerì— ëŒ€í•´ì„œ ì •ë§ ê°„ë‹¨íˆë§Œ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
ìì„¸í•œ ë‚´ìš©ì€ [ê³µì‹ë¬¸ì„œ](https://docs.docker.com/)ë¥¼ í¬í•¨í•œ ì—¬ëŸ¬ ì¢‹ì€ ìë£Œë“¤ì´ ìˆìœ¼ë¯€ë¡œ ì´ë“¤ì„ ì°¸ê³ í•´ì£¼ì‹œë©´ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤.ğŸ˜

<br/>
<br/>

### ğŸš€ DockerFileì´ ë­”ê°€ìš”?
`Docker Image`ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ì„¤ì • íŒŒì¼ì…ë‹ˆë‹¤.

<br/>
<br/>

### ğŸš€ Docker ImageëŠ” ë­”ê°€ìš”?
ì½”ë“œ, ëŸ°íƒ€ì„, ì‹œìŠ¤í…œ ë„êµ¬, ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ì„¤ì •ê³¼ ê°™ì€ ì‘ìš© í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ê²ƒì„ í¬í•¨í•˜ëŠ” ì‹¤í–‰ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.
`Docker Image`ë¥¼ ì‹¤í–‰ì‹œí‚´ìœ¼ë¡œì¨ `Docker Container`ê°€ ìƒì„±ë©ë‹ˆë‹¤.

<br/>
<br/>

### ğŸš€ Docker ContainerëŠ” ë­”ê°€ìš”?
ì»¨í…Œì´ë„ˆëŠ” ì´ë¯¸ì§€ì˜ ì‹¤í–‰ ê°€ëŠ¥í•œ ì¸ìŠ¤í„´ìŠ¤ì…ë‹ˆë‹¤.<br/>
ì´ë¯¸ì§€ë¡œë¶€í„° ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë˜ë©°, ì»¨í…Œì´ë„ˆëŠ” ì½”ë“œì™€ ëª¨ë“  ì¢…ì†ì„±ì„ íŒ¨í‚¤ì§€í™”í•˜ì—¬ ì‘ìš© í”„ë¡œê·¸ë¨ì´ í•˜ë‚˜ì˜ ì»´í“¨íŒ… í™˜ê²½ì—ì„œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.<br/>

ì¦‰ ì‰½ê²Œ ë§í•´ ì»¨í…Œì´ë„ˆ ì†ì— Spring ë“±ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë“¤ì–´ìˆê³ , ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•¨ìœ¼ë¡œì¨ ë‚´ë¶€ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ë¼ ìƒê°í•˜ë©´ í¸í•©ë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

## ğŸ§ ë°±ì—”ë“œ CD í”Œë¡œìš°ë¥¼ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•´ë³´ê¸°

Dockerë¥¼ í†µí•œ CD workflowë¥¼ ì‘ì„±í•˜ê¸° ì „ì—, ì–´ë–¤ ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ë¥¼ ì•Œì•„ì•¼ê² ì£ ?<br/>
ê·¸ë˜ì„œ ìš°ì„  ì „ì²´ì ì¸ ê³¼ì •ì„ ë¡œì»¬ì—ì„œ ì§ì ‘ ì§„í–‰í•œ ë’¤, í•´ë‹¹ ê³¼ì •ì„ ë°”íƒ•ìœ¼ë¡œ workflowë¥¼ ì‘ì„±í•˜ì—¬ ì‹¤í–‰í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

### ğŸš€ DockerFile ì‘ì„±í•˜ê¸°

ì‘ì„±ëœ DockerFileì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```dockerfile
FROM amazoncorretto:17-alpine-jdk

WORKDIR /app

COPY .backend/build/libs/celuveat-0.0.1-SNAPSHOT.jar /app/celuveat.jar

CMD ["java", "-jar", "celuveat.jar"]
```

í•œì¤„ í•œì¤„ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

```dockerfile
FROM amazoncorretto:17-alpine-jdk
```

Docker ì´ë¯¸ì§€ ìƒì„± ì‹œ ê¸°ë°˜ì´ ë˜ëŠ” ì´ë¯¸ì§€ ë ˆì´ì–´ë¥¼ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.<br/>
ì €í¬ì˜ í”„ë¡œì íŠ¸ëŠ” ìë°” 17ë²„ì „ì„ ì‚¬ìš©í•˜ë¯€ë¡œ amazoncorrettoì˜ jdk 17ë²„ì „ì„ Base imageë¡œ ê°€ì§€ê³  ì˜¤ë„ë¡ í•©ë‹ˆë‹¤.


<br/>
<br/>

```dockerfile
WORKDIR /app
```

ë„ì»¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œì˜ ì‘ì—… ë””ë ‰í† ë¦¬ë¥¼ `/app`ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.<br/>
ì´í›„ ì§„í–‰ë˜ëŠ” ì‘ì—…ë“¤ì€ ëª¨ë‘ `/app`  ë‚´ë¶€ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.

<br/>
<br/>

```dockerfile
COPY ./build/libs/celuveat-0.0.1-SNAPSHOT.jar /app/celuveat.jar
```
COPYë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì˜ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¡œ ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë¹Œë“œëœ jaríŒŒì¼ì€ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰í•´ì•¼ í•˜ë¯€ë¡œ, COPY ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆì˜ `/app ë””ë ‰í† ë¦¬(WORKDIR)`ì˜ ë‚´ë¶€ë¡œ ì´ë™ì‹œì¼œì¤ë‹ˆë‹¤.

<br/>
<br/>

```dockerfile
CMD ["java", "-jar", "celuveat.jar"]
```
Jar íŒŒì¼ì„ ì‹¤í–‰ì‹œí‚¤ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>

### ğŸš€ DockerFileì„ í†µí•´ Docker Image ë¹Œë“œí•˜ê¸°

ì´ì œ ìœ„ DockerFileì„ ë¹Œë“œí•˜ì—¬ Docker Imageë¥¼ ìƒì„±í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.


DockerFileì˜ ìœ„ì¹˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
![dockerfile](./dockerfile1.png)

<br/>

DockerFileì„ í†µí•´ Docker Imageë¥¼ ë¹Œë“œí•˜ê¸° ì „ì— JaríŒŒì¼ì„ ìš°ì„  ë¹Œë“œí•´ì•¼ í•©ë‹ˆë‹¤.


```bash
./gradlew bootJar
```

<br/>
<br/>

ì´í›„ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.

```bash
docker build -t celuveat/celuveat-backend ./
```

- `-t <name>:<tag>` : ë¹Œë“œí•  Imageì˜ ì´ë¦„ê³¼ tagë¥¼ ì •í•´ì¤ë‹ˆë‹¤.
 ì´ë•Œ tagëŠ” ìƒëµ ê°€ëŠ¥í•˜ë©°, ì´ë¦„ì˜ ê²½ìš° í¸ì˜ë¥¼ ìœ„í•´ ì´í›„ ìƒì„±í•  DockerHubì˜ namespace/repositoryìœ¼ë¡œ ì§€ì •í•˜ì˜€ìŠµë‹ˆë‹¤. <br/>
 ì €ëŠ” tagë¥¼ ìƒëµí–ˆìœ¼ë©°, ì´ ê²½ìš° `latest`ê°€ default tagë¡œ ë¶™ìŠµë‹ˆë‹¤.



![build](./dockerbuild.png)

ìœ„ì™€ ê°™ì´ ë¬¸ì œ ì—†ì´ ì„±ê³µí•  ê²ƒì¸ë°ìš”, ì´ì œ ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ í™•ì¸í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

```bash
docker images
```

![images](./dockerimages.png)

ìœ„ì™€ ê°™ì´ ì´ë¯¸ì§€ë„ ì˜ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

ì´ì œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ DockerHubì— ì˜¬ë¦° ë’¤, EC2ì—ì„œ ì´ë¥¼ ë‹¤ìš´ë°›ì•„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
ìš°ì„  í•´ë‹¹ ì´ë¯¸ì§€ê°€ ë¬¸ì œì—†ëŠ”ì§€ í™•ì¸í•´ë³´ê¸° ìœ„í•´ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>

### ğŸš€ DockerImage Localì—ì„œ ì‹¤í–‰í•´ë³´ê¸°

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

```bash
docker run \
-d \
--rm \
--name backend \
-p 8080:8080 \
-e "SPRING_PROFILE=local" \
celuveat/celuveat-backend
```

- -d : ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
- --name <ì´ë¦„> : ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ì„ ì§€ì •í•©ë‹ˆë‹¤.
- --rm : ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
- -p 8080:8080 : í˜¸ìŠ¤íŠ¸ì˜ í¬íŠ¸(ì™¸ë¶€ í¬íŠ¸)(ì¢Œì¸¡ 8080)ë¥¼ ì»¨í…Œì´ë„ˆì˜ í¬íŠ¸ 8080ìœ¼ë¡œ ë§¤í•‘í•©ë‹ˆë‹¤.
- -e : í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
- celuveat/celuveat-backend : ì‹¤í–‰í•  Docker Imageì˜ ì´ë¦„(ì •í™•íˆëŠ” íƒœê·¸)ì„ ëª…ì‹œí•©ë‹ˆë‹¤.

<br/>

ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰ëœë‹¤ë©´ ë¬¸ì œê°€ ì—†ëŠ” ê²ƒì…ë‹ˆë‹¤.
![run](./dockerrun.png)

<br/>

ì´ì–´ì„œ ì˜ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ ë¡œê·¸ë¥¼ í™•ì¸í•´ë³´ê² ìŠµë‹ˆë‹¤.

```bash
docker logs backend
```
![log](./dockerlog.png)

ì˜ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

ì´ì œ ë¡œì»¬ì—ì„œ ì‹¤í–‰ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë©ˆì¶˜ ë’¤ ì´ë¥¼ DockerHubì— ì˜¬ë¦¬ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ì‹¤í–‰ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ ë‹¤ìŒê³¼ ê°™ì´ ë©ˆì¶œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
```
docker stop backend || true
```
ì—¬ê¸°ì„œ `backend`ëŠ” `container`ì˜ ì´ë¦„ì…ë‹ˆë‹¤.
- || true : ë„ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰í•˜ë„ë¡ í•©ë‹ˆë‹¤.

![dockerstop](./dockerstop.png)

ë‹¤ìŒê³¼ ê°™ì´ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì—ˆìœ¼ë©°, --rm ì˜µì…˜ìœ¼ë¡œ ì¸í•´ ìë™ìœ¼ë¡œ ì œê±°ëœ ê²ƒ ê¹Œì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.



<br/>
<br/>
<br/>
<br/>
<br/>

### ğŸš€DockerHubì— Docker Image Pushí•˜ê¸°
ì´ì œ DockerHubì— Docker Imageë¥¼ Pushí•˜ëŠ” ê³¼ì •ì„ ì•Œì•„ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ìš°ì„  ì´ë¥¼ ìœ„í•´ DockerHubì— ê°€ì…í•œ ë’¤, ë‹¤ìŒê³¼ ê°™ì´ Repositoryë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
![repo](./dockerhubrepository.png)

<br/>
<br/>

í•´ë‹¹ Repositoryì— pushí•˜ëŠ”ê²ƒì€ ê°„ë‹¨í•©ë‹ˆë‹¤.

ìš°ì„  ë¡œê·¸ì¸ì„ ì§„í–‰í•©ë‹ˆë‹¤.

```bash
docker login
```

![login](./dockerlogin.png)


<br/>
<br/>

```bash
docker push celuveat/celuveat-backend
```

![push](./dockerhubpush.png)

(ì´ë•Œ ë§Œì•½ build ì‹œ tagë¥¼ ë‹¤ë¥´ê²Œ ì£¼ì—ˆë‹¤ë©´, ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´ tagë¥¼ ìƒˆë¡œ ë‹¬ì•„ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
```java
docker tag <ë¡œì»¬ì´ë¯¸ì§€ì´ë¦„>:<íƒœê·¸> <dockerhub namespace>/<repository ì´ë¦„>:<íƒœê·¸>
```
ë˜í•œ ì´ë•Œ íƒœê·¸ëŠ” ìƒëµ ê°€ëŠ¥í•˜ë©°, ìƒëµí•˜ëŠ” ê²½ìš° latestê°€ defaultë¡œ ë¶™ìŠµë‹ˆë‹¤.)

<br/>
<br/>

push ì´í›„ DockerHubì˜ Repositoryë¡œ ë“¤ì–´ê°€ë³´ë©´, ë‹¤ìŒê³¼ ê°™ì´ ì´ë¯¸ì§€ê°€ pushë˜ì–´ ìˆëŠ”ê²ƒì„ í™•ì¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![pushed](./pushed.png)

<br/>
<br/>
<br/>
<br/>
<br/>

### ğŸš€ EC2ì—ì„œ Imageë¥¼ Pull ë°›ì•„ ì‹¤í–‰í•´ë³´ê¸°
ì´ì œ EC2ì—ì„œ DockerHubì— ì˜¬ë¼ê°„ ì´ë¯¸ì§€ë¥¼ Pullë°›ì•„ ì´ë¥¼ ì‹¤í–‰ì‹œí‚¤ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br/>
ìš°ì„  ì´ë¥¼ ìœ„í•´ í…ŒìŠ¤íŠ¸ìš© EC2ë¥¼ í•˜ë‚˜ ìƒˆë¡œ ìƒì„±í•´ ì£¼ì—ˆìŠµë‹ˆë‹¤.

Dockerë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— EC2ì— javaë¥¼ ë”°ë¡œ ì„¤ì¹˜í•  í•„ìš”ëŠ” ì—†ì§€ë§Œ, dockerëŠ” ì„¤ì¹˜í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.<br/>
[ë‹¤ìŒ ë¬¸ì„œ](https://docs.docker.com/engine/install/ubuntu/)ì— ë”°ë¼ ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
```bash
sudo apt-get update
sudo apt-get install ca-certificates curl gnupg
```

```bash
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```

```bash
echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```

```bash
sudo apt-get update
```

```bash
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

<br/>
<br/>

ì´ì œ DockerHubì—ì„œ imageë¥¼ pull ë°›ì•„ ì‚¬ìš©í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

ì €í¬ëŠ” private repositoryë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ìš°ì„  ë¡œê·¸ì¸ì„ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

```bash
docker login
```

ê·¸ëŸ°ë° ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ì„œ ì¸ì¦ì„ ì§„í–‰í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ `permission denied` ì˜¤ë¥˜ê°€ ëœ° ê²ƒì…ë‹ˆë‹¤.
![denied](./permissiondenied.png)

ìœ„ ì˜¤ë¥˜ëŠ” Dockerì˜ ë°ëª¬ ì†Œì¼“ íŒŒì¼ì¸ `/var/run/docker.sock`ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ë¶€ì¡±í•˜ì—¬ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ì…ë‹ˆë‹¤.

<br/>

ì´ë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì€ í¬ê²Œ ë‘ê°€ì§€ê°€ ìˆëŠ”ë°, í•˜ë‚˜ëŠ” `sudo`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ê³ , ë‹¤ë¥¸ í•˜ë‚˜ëŠ” Docker ê·¸ë£¹ì— ì‚¬ìš©ìë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.<br/>
ì €ëŠ” ë‘ë²ˆì§¸ ë°©ë²•ìœ¼ë¡œ í•´ê²°í•´ ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.<br/>

```bash
sudo usermod -aG docker $USER
```
ìœ„ëŠ” í˜„ì¬ ì‚¬ìš©ì($USER)ë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€í•˜ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.

<br/>

ì´í›„ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
newgrp docker
```

<br/>

ì´ì œ ë‹¤ì‹œ ë¡œê·¸ì¸ì„ ì‹œë„í•˜ë©´ ì„±ê³µí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![login](./dockerlogin.png)

<br/>
<br/>


DockerHubì—ì„œ Imageë¥¼ Pull í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```bash
docker pull celuveat/celuveat-backend
```
(ë§Œì•½ íƒœê·¸ë¥¼ ë¶™ì—¬ì£¼ì—ˆë‹¤ë©´ íƒœê·¸ë„ ê°™ì´ ëª…ì‹œí•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë©´ latestê°€ defaultë¡œ ë¶™ìŠµë‹ˆë‹¤.)

![pulled](./dockerpulled.png)

<br/>

ì´ì œ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ì‹¤í–‰í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
```bash
docker run \
-d \
--rm \
--name backend \
-p 8080:8080 \
-e "SPRING_PROFILE=local" \
celuveat/celuveat-backend
```

![docker run2](./dockerun2.png)

ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì˜ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ì œ ì´ë¥¼ stop ëª…ë ¹ì–´ë¥¼ í†µí•´ ì¢…ë£Œí•´ì¤€ í›„, í…ŒìŠ¤íŠ¸ë¥¼ ëë§ˆì¹˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>

## ğŸ§ ë°±ì—”ë“œ CD workflow ì‘ì„±í•˜ê¸°
ì´ì œ ìœ„ ê³¼ì •ì„ Github Actionsì™€ self-hosted runnersë¥¼ í†µí•´ ìë™í™”í•  ìˆ˜ ìˆë„ë¡ workflowë¥¼ ì‘ì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
(devì™€ prodëŠ” ëŒ€ì²´ë¡œ ë™ì¼í•˜ë¯€ë¡œ, prodìš© workflowë§Œì„ ì‘ì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.)

```yml
name: âœ¨ Celuveat backend PROD CD âœ¨

env:
  PROFILE: prod
  IMAGE_TAG: prod-${{ secrets.APP_VERSION_TAG }}
  DOCKER_CONTAINER_NAME: backend

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  backend-docker-build-and-push:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: âœ¨ Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.ACTION_TOKEN }}

      - name: âœ¨ JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
        run: ./gradlew bootJar

      - name: âœ¨ DockerHubì— ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_BACKEND_USERNAME }}
          password: ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}

      - name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/arm64
          tags: celuveat/celuveat-backend:${{ env.IMAGE_TAG }}

  backend-docker-pull-and-run:
    runs-on: [self-hosted, prod]
    if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
    needs: [ backend-docker-build-and-push ]
    steps:
      - name: âœ¨ DockerHubì—ì„œ Image Pull
        run: |
          docker login --username ${{ secrets.DOCKERHUB_BACKEND_USERNAME }} --password ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}
          docker pull celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
          docker stop ${{ env.DOCKER_CONTAINER_NAME }} || true
          docker container prune -f
          docker image prune -f

      - name: âœ¨ Docker Image ì‹¤í–‰
        run: |
          docker run \
            -d \
            --name ${{ env.DOCKER_CONTAINER_NAME }} \
            -p 8080:8080 \
            -e "SPRING_PROFILES_ACTIVE=${{ env.PROFILE }}" \
            celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
```


ì´ë¥¼ í•˜ë‚˜í•˜ë‚˜ ì‚´í´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

```yml
env:
  PROFILE: prod
  IMAGE_TAG: prod-${{ secrets.APP_VERSION_TAG }}
  DOCKER_CONTAINER_NAME: backend
```
yml ë‚´ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ì„ ì •ì˜í•´ì£¼ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
- PROFILE: ìŠ¤í”„ë§ì„ ì‹¤í–‰í•  ë•Œ `SPRING_PROFILES_ACTIVE`ì˜ ê°’ìœ¼ë¡œ ì¤„ ê°’ì…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ìš© workflowì´ë¯€ë¡œ `prod`ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- IMAGE_TAG: ë„ì»¤ ì´ë¯¸ì§€ë¥¼ í™˜ê²½&ë²„ì „ë³„ë¡œ ê´€ë¦¬í•˜ê¸° ìœ„í•œ íƒœê·¸ë¥¼ ë§Œë“œëŠ” ë¶€ë¶„ìœ¼ë¡œ, `prod-1.0.0` ì˜ í˜•ì‹ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
- DOCKER_CONTAINER_NAME: Docker Image ë¡œë¶€í„° ìƒì„±ë  Containerì˜ ì´ë¦„ì„ ì •ì˜í•´ì£¼ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

<br/>
<br/>

```yml
on:
  push:
    branches:
      - main
    paths:
      - "backend/**"
```
í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ë™ì‘í• ì§€ë¥¼ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí•˜ì˜€ì„ ë•Œ, backendì˜ í•˜ìœ„ ë””ë ‰í† ë¦¬ì— ë³€ê²½ì´ ìƒê²¼ì„ ê²½ìš° í•´ë‹¹ workflowê°€ ë™ì‘í•©ë‹ˆë‹¤.

<br/>
<br/>

```yml
jobs:
  backend-docker-build-and-push:
    # ...

  backend-docker-pull-and-run:
    # ...
```
workflowì—ì„œ ì‹¤í–‰í•  ì‘ì—…(job)ë“¤ì„ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
í•´ë‹¹ workflowì—ì„œëŠ” `backend-docker-build-and-push`ì™€ `backend-docker-pull-and-run` ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—…ì´ ë‘ê°œ ì¡´ì¬í•©ë‹ˆë‹¤.

<br/>
<br/>

```yml
backend-docker-build-and-push:
  runs-on: ubuntu-latest
  defaults:
    run:
      working-directory: ./backend
```
- backend-docker-build-and-push : ì‘ì—…ì´ ìˆ˜í–‰ë˜ëŠ” í™˜ê²½ì€ ubuntu-latestì…ë‹ˆë‹¤.
- defaults.run.working-directory: ./backend : defaults ë¥¼ í†µí•´ ì•„ë˜ì˜ ë‹¨ê³„ì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” ì„¤ì •ì„ ì§€ì •í•˜ì˜€ìŠµë‹ˆë‹¤.
í•´ë‹¹ ì‘ì—…ì—ì„œëŠ” `working-directory`ë¥¼ ì„¤ì •í•˜ì—¬ ì´í›„ì˜ ë‹¨ê³„ë“¤ì€ ëª¨ë‘ `./backend` ë””ë ‰í† ë¦¬ ë‚´ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.

<br/>
<br/>

```yml
steps:
  - name: âœ¨ Checkout repository
    uses: actions/checkout@v3
    with:
      submodules: true
      token: ${{ secrets.ACTION_TOKEN }}
```
onì— ì •ì˜ëœ main ë¸Œëœì¹˜ë¡œ checkoutí•˜ë©°, ë™ì‹œì— submodulesì„ í¬í•¨í•˜ì—¬ ê°€ì ¸ì˜¤ë„ë¡ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.

ì´ë•Œ Secretì— ACTION_TOKENìœ¼ë¡œ ì •ì˜ëœ ê°’ì„ ì‚¬ìš©í•˜ëŠ”ë°, í•´ë‹¹ ê°’ì€ ì•„ë˜ì™€ ê°™ì´ ë°œê¸‰í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![token1](./token1.png)
(ê¹ƒí—ˆë¸Œì˜ ìš°ì¸¡ ìƒë‹¨ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í´ë¦­ -> Settings)

<br/>
<br/>

![token2](./token2.png)
(Developer Settings í´ë¦­)

<br/>
<br/>

![token3](./token3.png)
(Personal Access Token -> Tokens (classic) -> Generate new token -> Generate new token (classic))


<br/>
<br/>

![token4](./token4.png)
`repo`ì— ëŒ€í•´ì„œë§Œ ì²´í¬í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

ì´ë ‡ê²Œ í•´ì„œ ìƒì„±ëœ Tokenì„ Repository Secretìœ¼ë¡œ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.<br/>
(workflowë¥¼ ì‚¬ìš©í•  Repository -> Settings -> Secrets and variables -> New repository secretì„ í†µí•´ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)


<br/>
<br/>

```yml
- name: âœ¨ JDK 17 ì„¤ì •
  uses: actions/setup-java@v3
  with:
    java-version: '17'
    distribution: 'temurin'
```

ì‚¬ìš©í•  ìë°” ë²„ì „ì„ ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
17ë²„ì „ì„ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í•˜ì˜€ìŠµë‹ˆë‹¤.


<br/>
<br/>

```yml
- name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
  run: chmod +x ./gradlew

- name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
  run: ./gradlew bootJar
```

gradlew ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•œ í›„ jootJarì„ í†µí•´ jar íŒŒì¼ì„ ë¹Œë“œí•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.

<br/>
<br/>

```yml
- name: âœ¨ DockerHubì— ë¡œê·¸ì¸
  uses: docker/login-action@v2
  with:
    username: ${{ secrets.DOCKERHUB_BACKEND_USERNAME }}
    password: ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}
```
Secretsì— ì •ì˜í•œ usernameê³¼ passwordë¥¼ í†µí•´ DockerHubì— ë¡œê·¸ì¸í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.


<br/>
<br/>

```yml
- name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
  uses: docker/build-push-action@v4
  with:
    context: ./backend
    file: ./backend/Dockerfile
    push: true
    platforms: linux/arm64
    tags: celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
```
- [docker/build-push-action@v4](https://github.com/docker/build-push-action)ë¥¼ í†µí•´ DockerHubì— ì´ë¯¸ì§€ë¥¼ pushí•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤.
- context: Docker Imageë¥¼ ë¹Œë“œí•  ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤. ./backendë¥¼ í†µí•´ ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì§€ì •í–ˆìŠµë‹ˆë‹¤.
- file: ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•  DockerFileì˜ ìœ„ì¹˜ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
- push: DockerHubì— ì´ë¯¸ì§€ë¥¼ í‘¸ì‰¬í• ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤. trueë¡œ ì„¤ì •í•˜ì—¬ í‘¸ì‰¬í•˜ë„ë¡ í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.
- ë¹Œë“œí•  ì´ë¯¸ì§€ í”Œë«í¼ì„ ì§€ì •í•©ë‹ˆë‹¤. ì €í¬ì˜ ì„œë²„ëŠ” ubuntu(Linux/UNIX) 64-bit(ARM) ì´ë¯€ë¡œ linux/arm64ë¡œ ì§€ì •í•˜ì˜€ìŠµë‹ˆë‹¤.
- ë¹Œë“œë  ì´ë¯¸ì§€ì˜ íƒœê·¸ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

<br/>
<br/>

ìœ„ ê³¼ì •ì„ ì§„í–‰í•˜ë©´ DockerHubì— ë‹¤ìŒê³¼ ê°™ì´ ì´ë¯¸ì§€ê°€ ì˜¬ë¼ê°€ê²Œë©ë‹ˆë‹¤.
![pushed](./dockerhubpushed.png)

ì´ì–´ì„œ EC2ì—ì„œ Self hosted Runnerë¥¼ í†µí•´ í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ Pull ë°›ì•„ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

```yml
backend-docker-pull-and-run:
  runs-on: [self-hosted, prod]
  if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
  needs: [ backend-docker-build-and-push ]
```
- runs-on: ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ì„ ì§„í–‰í•©ë‹ˆë‹¤. prod í™˜ê²½ì˜ self-hosted-runnerë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•´ ì´ì™€ ê°™ì´ ì§€ì •í–ˆìŠµë‹ˆë‹¤.
(prodëŠ” ì´ì „ ê¸€ì—ì„œ ì‚´í´ë³´ì•˜ë“¯ì´, ì§ì ‘ self hosted runnersì— ì§ì ‘ ë¶™ì—¬ì¤€ labelì…ë‹ˆë‹¤.)
- if: ì´ì „ ì‘ì—…ì¸ backend-docker-build-and-pushê°€ ì„±ê³µí–ˆì„ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë˜ë„ë¡ ifë¥¼ í†µí•´ ì¡°ê±´ì„ ì§€ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.
- needs: í•´ë‹¹ ì‘ì—…ì´ ì˜ì¡´í•˜ëŠ” ì‘ì—…ì„ ì§€ì •í•©ë‹ˆë‹¤. í•´ë‹¹ ì‘ì—…ì€ backend-docker-build-and-push ë’¤ì— ì‹¤í–‰ë˜ì•¼ í•˜ë¯€ë¡œ needsë¥¼ í†µí•´ ì§€ì •í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.

<br/>
<br/>

```yml
steps:
  - name: âœ¨ DockerHubì—ì„œ Image Pull
    run: |
      docker login --username ${{ secrets.DOCKERHUB_BACKEND_USERNAME }} --password ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}
      docker pull celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
      docker stop ${{ env.DOCKER_CONTAINER_NAME }} || true
      docker container prune -f
      docker image prune -f
```
- docker login ~ : dockerhubì— ë¡œê·¸ì¸í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
- docker pull ~ : ì´ì „ ì‘ì—…ì—ì„œ dockerhubì— pushí•œ ì´ë¯¸ì§€ë¥¼ pullí•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
- docker stop ~ : EC2ì— ì‹¤í–‰ì¤‘ì¸ docker container(ì—¬ê¸°ì„œëŠ” Spring Application)ê°€ ìˆìœ¼ë©´ ì´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
  - || true ë¥¼ í†µí•´ backendë¼ëŠ” ì»¨í…Œì´ë„ˆê°€ ì—†ë”ë¼ë„ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•Šê³  ì§„í–‰í•˜ë„ë¡ í•©ë‹ˆë‹¤.
- docker container prune -f: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤. -fë¥¼ í†µí•´ ì‚¬ìš©ìì˜ í™•ì¸ì„ ë¬»ì§€ ì•Šê³  ì§„í–‰í•©ë‹ˆë‹¤.
- docker image prune -f: ì´ë¦„ ì—†ëŠ” ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.


<br/>
<br/>

```yml
- name: âœ¨ Docker Image ì‹¤í–‰
  run: |
    docker run \
      -d \
      --name ${{ env.DOCKER_CONTAINER_NAME }} \
      -p 8080:8080 \
      -e "SPRING_PROFILES_ACTIVE=${{ env.PROFILE }}" \
      celuveat/celuveat-backend:${{ env.IMAGE_TAG }
```

ìœ„ ì˜µì…˜ë“¤ì€ ëª¨ë‘ ì´ì „ì— ì„¤ëª…í•œ ì˜µì…˜ë“¤ì´ë¯€ë¡œ ë”°ë¡œ ì„¤ëª…í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

## ğŸ§ ì„±ëŠ¥ í–¥ìƒ ê³ ë ¤í•˜ê¸°

### ğŸš€ Gradle Caching

í˜„ì¬ github actionsì˜ workflowê°€ (jar íŒŒì¼ì˜ ë³€ê²½ ì—†ì´) ì „ì²´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

![no-caching-1](./no-caching-1.png)
![no-caching-2](./no-caching-2.png)
![no-caching-3](./no-caching-3.png)
![no-caching-4](./no-caching-4.png)

í‰ê· ì ìœ¼ë¡œ 1ë¶„ 10ì´ˆ ì •ë„ì˜ ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë¥¼ ì¤„ì´ê¸° ìœ„í•´ Gradle Cachingì„ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>

### Gradle Cachingì´ë€?
(ì°¸ê³  - [ê³µì‹ë¬¸ì„œ](https://docs.gradle.org/current/userguide/core_dependency_management.html#sec:dependency-mgmt-in-gradle))<br/>
Gradleì€ ë¹Œë“œ ì‹œì— ì‘ì—…(Task)ì˜ì¡´ì„± íŒ¨í‚¤ì§€ë“¤ì„ ëª¨ë‘ ê°€ì ¸ì˜¨ ë’¤, ì´ë“¤ì„ dependency cacheë¼ ë¶ˆë¦¬ëŠ” ë¡œì»¬ ìºì‹œì— ë³´ê´€í•˜ì—¬
ì´í›„ í˜¸ì¶œì—ì„œ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì„ ë°©ì§€í•˜ëŠ” ì „ëµì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ Github Actionsì˜ workflowì—ì„œëŠ” ë§¤ ì‹¤í–‰ë§ˆë‹¤ ìƒˆë¡­ê²Œ ì˜ì¡´ì„±ë“¤ì„ ê°€ì§€ê³  ì˜¤ê²Œ ë©ë‹ˆë‹¤.<br/>
ì˜ì¡´ì„±ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ëŒ€ì²´ë¡œ ë„¤íŠ¸ì›Œí¬ í˜¸ì¶œì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, í•´ë‹¹ ê³¼ì •ì´ ì—†ì–´ì§„ë‹¤ë©´ ì „ì²´ ë¹Œë“œ ì‹œê°„ì´ ë§¤ìš° ë‹¨ì¶•ë  ê²ƒì´ë¼ ì˜ˆìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•œë²ˆ Gradle Cachingì„ ì ìš©í•˜ì—¬ ì„±ëŠ¥ í–¥ìƒì´ ì–¼ë§ˆë‚˜ ì´ë£¨ì–´ì§€ëŠ”ì§€ í™•ì¸í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.
ë°©ë²•ì€ ë§¤ìš° ê°„ë‹¨í•©ë‹ˆë‹¤.
```yml
- name: âœ¨ Gradle Caching
  uses: actions/cache@v3
  with:
    path: |
        ~/.gradle/caches
        ~/.gradle/wrapper
    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
    restore-keys: |
        ${{ runner.os }}-gradle-
```

ìœ„ ì½”ë“œë¥¼ ì¶”ê°€í•´ì£¼ë©´ ë˜ëŠ”ë°ìš”, ì´ë¥¼ ì ìš©í•œ ì „ì²´ workflowëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<br/>
<br/>

```yml
name: âœ¨ Celuveat backend PROD CD âœ¨

env:
  PROFILE: prod
  IMAGE_TAG: prod-${{ secrets.APP_VERSION_TAG }}
  DOCKER_CONTAINER_NAME: backend

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  backend-docker-build-and-push:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: âœ¨ Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.ACTION_TOKEN }}

      - name: âœ¨ JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âœ¨ Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
              ~/.gradle/caches
              ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
              ${{ runner.os }}-gradle-

      - name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
        run: ./gradlew bootJar

      - name: âœ¨ DockerHubì— ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_BACKEND_USERNAME }}
          password: ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}

      - name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/arm64
          tags: celuveat/celuveat-backend:${{ env.IMAGE_TAG }}

  backend-docker-pull-and-run:
    runs-on: [self-hosted, prod]
    if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
    needs: [ backend-docker-build-and-push ]
    steps:
      - name: âœ¨ DockerHubì—ì„œ Image Pull
        run: |
          docker login --username ${{ secrets.DOCKERHUB_BACKEND_USERNAME }} --password ${{ secrets.DOCKERHUB_BACKEND_PASSWORD }}
          docker pull celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
          docker stop ${{ env.DOCKER_CONTAINER_NAME }} || true
          docker container prune -f
          docker image prune -f

      - name: âœ¨ Docker Image ì‹¤í–‰
        run: |
          docker run \
            -d \
            --name ${{ env.DOCKER_CONTAINER_NAME }} \
            -p 8080:8080 \
            -e "SPRING_PROFILES_ACTIVE=${{ env.PROFILE }}" \
            celuveat/celuveat-backend:${{ env.IMAGE_TAG }}
```

<br/>
<br/>

ìºì‹±ì„ ì ìš©í•œ github actionsì˜ workflowê°€ (jar íŒŒì¼ì˜ ë³€ê²½ ì—†ì´) ì „ì²´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

#### ì²« ì‹¤í–‰
![yes-caching-1](./yes-caching-1.png)

#### ì´í›„ ì‹¤í–‰
![yes-caching-2](./yes-caching-2.png)
![yes-caching-3](./yes-caching-3.png)
![yes-caching-4](./yes-caching-4.png)
![yes-caching-5](./yes-caching-5.png)

<br/>

ê°„ë‹¨í•œ ê·¸ë˜ì´ë“¤ ìºì‹±ë§Œìœ¼ë¡œë„ (ì²« ì‹¤í–‰ ì œì™¸) ì„±ëŠ¥ì´ ëŒ€ëµ 25%ì •ë„ í–¥ìƒëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>
<br/>
<br/>
<br/>
<br/>

ì´ ë°©ë²• ì™¸ì—ë„, COPY ëŒ€ì‹  BIND MOUNTë¥¼ í™œìš©í•˜ì—¬ ì„±ëŠ¥ì„ ì¢€ ë” ë†’ì—¬ë³¼ ìˆ˜ ìˆê² ë‹¤ê³  ìƒê°í•˜ì§€ë§Œ,
ì§€ê¸ˆì€ ì‹œê°„ì´ ë„ˆë¬´ ì—†ì–´ì„œ ë‹¤ìŒìœ¼ë¡œ ë¯¸ë¤„ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤..!!

ì´ë ‡ê²Œ í•´ì„œ ì´ë²ˆ ê¸€ì—ì„œëŠ” ì €í¬ ë°±ì—”ë“œ íŒ€ì˜ Dockerë¥¼ í†µí•œ CD í™˜ê²½ êµ¬ì¶• ê³¼ì •ì„ ì‚´í´ë³´ì•˜ê³ , <br/>
ë‹¤ìŒ ê¸€ì—ì„œëŠ” í”„ë¡ íŠ¸ì—”ë“œ íŒ€ì˜ Dockerë¥¼ í†µí•œ CD í™˜ê²½ êµ¬ì¶• ê³¼ì •ì„ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

<br/>
<br/>

