---
date: 2023-10-21
authors: kdkdhoho
title: "ì…€ëŸ½ì‡ì˜ ë¬´ì¤‘ë‹¨ ë°°í¬ ì ìš©ê¸°"
description: "ì…€ëŸ½ì‡ì˜ ë¬´ì¤‘ë‹¨ ë°°í¬ ì ìš©ê¸°"
keywords: ["ë¬´ì¤‘ë‹¨ë°°í¬", "Infra"]
tags:
  - ë¬´ì¤‘ë‹¨ë°°í¬
  - Infra
---

ì…€ëŸ½ì‡ì˜ ë¬´ì¤‘ë‹¨ ë°°í¬ ì ìš©ê¸°

<!--truncate-->

ì•ˆë…•í•˜ì„¸ìš”. ì…€ëŸ½ì‡ íŒ€ ë°±ì—”ë“œ ë„ê¸°ì…ë‹ˆë‹¤. ğŸ¶<br/>
ì´ë²ˆ ê¸€ì—ì„  ì…€ëŸ½ì‡ì´ ì–´ë–»ê²Œ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ì ìš©í–ˆëŠ” ì§€ì— ëŒ€í•´ ì‘ì„±í•˜ê³ ì í•©ë‹ˆë‹¤.<br/>
ê·¸ëŸ¼ ë°”ë¡œ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤.

# ğŸ¤”ì–´ë–»ê²Œ ì ìš©í• ê¹Œ?

## Rolling? ë¸”ë£¨/ê·¸ë¦°?

í˜„ì¬ ë°°í¬ ì„œë²„ë¡œ EC2 ì¸ìŠ¤í„´ìŠ¤ 1ëŒ€ë¥¼ ì‚¬ìš©ì¤‘ì…ë‹ˆë‹¤.<br/>
ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¶”ê°€ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„  ê¸°ìˆ  ê²€í†  ìš”ì²­ì„ ë³´ë‚´ì•¼ í•˜ë©° ê·¸ë™ì•ˆì˜ ëŒ€ê¸° ì‹œê°„ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë˜, ì¶”ê°€ ì‚¬ìš©ì´ ê°€ëŠ¥í•œì§€ë„ ë¯¸ì§€ìˆ˜ì…ë‹ˆë‹¤.

ë”°ë¼ì„œ í•œ ëŒ€ì˜ ì„œë²„ì—ì„œë„ ì¶©ë¶„íˆ ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆë‹¤ê³  íŒë‹¨í–ˆê¸°ì— **ë¸”ë£¨/ê·¸ë¦°** ë°©ì‹ì„ ì ìš©í•©ë‹ˆë‹¤.

# ğŸ¤”ë°°í¬ ì‹œë‚˜ë¦¬ì˜¤

ê¸°ë³¸ì ìœ¼ë¡œ 8080í¬íŠ¸ì™€ 8081í¬íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì „ì²´ì ì¸ ì‹œë‚˜ë¦¬ì˜¤ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ê·¸ë¦°ì´ **ë°°í¬ë  í¬íŠ¸(Idle Port)**ë¥¼ ì°¾ëŠ”ë‹¤.
2. ê·¸ë¦°ì„ **ë°°í¬**í•œë‹¤.
3. ê·¸ë¦° **í—¬ìŠ¤ ì²´í¬**ë¥¼ ì§„í–‰í•œë‹¤.
4. ë¬¸ì œê°€ ì—†ë‹¤ë©´, **Nginxì˜ í¬íŠ¸ í¬ì›Œë”© ì„¤ì •**ì„ **ê·¸ë¦°ìœ¼ë¡œ ë³€ê²½**í•˜ê³  **ë¸”ë£¨ë¥¼ ì¢…ë£Œ**í•œë‹¤.<br/>
ë¬¸ì œê°€ ìˆë‹¤ë©´, **ê·¸ë¦°ì„ ì¢…ë£Œí•œë‹¤.**

ì´ì œ ìœ„ ì‹œë‚˜ë¦¬ì˜¤ì˜ ê³¼ì •ì— ëŒ€í•´ ë” ìì„¸íˆ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

Idle PortëŠ” 8080 í¬íŠ¸ì— ìš”ì²­ì„ ì˜ì•„ë³´ê³  ì‘ë‹µì˜ ê²°ê³¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.<br/>
ë§Œì•½ ì‘ë‹µ ì½”ë“œê°€ 200ì´ë©´ í˜„ì¬ 8080 í¬íŠ¸ì—ì„œ ë¸”ë£¨ê°€ ë™ì‘ì¤‘ì¸ ì…ˆì´ë‹ˆ 8081í¬íŠ¸ê°€ Idle Portê°€ ë©ë‹ˆë‹¤.

ì´ë ‡ê²Œ ì°¾ì€ í¬íŠ¸ë¡œ ê·¸ë¦°ì„ ë°°í¬í•©ë‹ˆë‹¤.

ê·¸ ë‹¤ìŒ ê·¸ë¦°ì˜ í—¬ìŠ¤ ì²´í¬ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•´ 30ì´ˆì˜ ëŒ€ê¸° ì‹œê°„ì„ ê°€ì§‘ë‹ˆë‹¤.<br/>
ì´ìœ ëŠ” ê³§ë°”ë¡œ ì‹¤í–‰í•œ í—¬ìŠ¤ ì²´í¬ ì´í›„ì— ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©ìœ¼ë¡œ ê·¸ë¦° ì„œë²„ê°€ ì£½ê²Œë  ê°€ëŠ¥ì„±ì„ ì—¼ë‘í•´ë‘ì—ˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  í˜„ì¬ ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì„œë²„ì— ì œëŒ€ë¡œ ë„ì–´ì§€ê¸°ê¹Œì§€ ì•½ 20ì´ˆì˜ ì‹œê°„ì´ ì†Œìš”ë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

í—¬ìŠ¤ ì²´í¬ ê²°ê³¼, ê·¸ë¦° ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ë°°í¬ê°€ ëë‹¤ë©´ Nginxì˜ í¬íŠ¸ í¬ì›Œë”© ì„¤ì •ì„ ë³€ê²½í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  5ì´ˆì˜ ëŒ€ê¸° ì‹œê°„ì„ ì£¼ê³  ë¸”ë£¨ ì„œë²„ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.<br/>
ê·¸ë¦° ì„œë²„ì— ë¬¸ì œê°€ ìƒê²¨ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì¢…ë£Œí•©ë‹ˆë‹¤.

```bash
RESPONSE_CODE=$(curl -o /dev/null -w "%{http_code}" http://localhost:8080/celebs)
if [ ${RESPONSE_CODE} = 200 ];
    then
        IDLE_PORT=8081
        IDLE_MONITORING_PORT=18082
        USED_PORT=8080
    else
        IDLE_PORT=8080
        IDLE_MONITORING_PORT=18081
        USED_PORT=8081
fi

echo "IDLE_PORT=${IDLE_PORT}"
echo "IDLE_MONITORING_PORT=${IDLE_MONITORING_PORT}"

IMAGE_TAG=back-prod-${APP_VERSION_TAG}
DOCKER_CONTAINER_NAME=backend-${IDLE_PORT}
DOCKER_HUB_REPOSITORY=celuveat/celuveat
SERVER_LOG_DIR_PATH=~/log
DOCKER_LOG_DIR_PATH=/app/logs

docker pull ${DOCKER_HUB_REPOSITORY}:${IMAGE_TAG}
docker run \
-d \
--name ${DOCKER_CONTAINER_NAME} \
-p $IDLE_PORT:8080 \
-p $IDLE_MONITORING_PORT:18080 \
-e "SPRING_PROFILES_ACTIVE=prod" \
-v ${SERVER_LOG_DIR_PATH}:${DOCKER_LOG_DIR_PATH} \
${DOCKER_HUB_REPOSITORY}:${IMAGE_TAG}

# ìƒˆë¡œ ëœ¬ ì»¨í…Œì´ë„ˆ í™•ì¸
sleep 30
HEALTHY_CODE=$(curl -o /dev/null -w "%{http_code}" http://localhost:${IDLE_PORT}/celebs)
if [ ${HEALTHY_CODE} != 200 ];
    then
            IDLE_CONTAINER_ID=$(docker ps -q --filter "publish=${IDLE_PORT}")
            docker stop ${IDLE_CONTAINER_ID}
            docker rm ${IDLE_CONTAINER_ID}
            echo "TERMINATED"
            exit 1
fi

echo "set \$service_url http://127.0.0.1:${IDLE_PORT};set \$service_monitoring_url http://127.0.0.1:${IDLE_MONITORING_PORT};" | sudo tee /etc/nginx/conf.d/service-url.inc
sudo service nginx reload

sleep 5
USED_CONTAINER_ID=$(docker ps -q --filter "publish=${USED_PORT}")
docker stop ${USED_CONTAINER_ID}
docker rm ${USED_CONTAINER_ID}
docker image prune -f
```

# ğŸ¤”ëª¨ë‹ˆí„°ë§ì€..?

ê¸°ì¡´ì— ëª¨ë‹ˆí„°ë§ì„ ìœ„í•´ Spring Actuatorì˜ í¬íŠ¸ë¡œ `18080` í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì—ˆìŠµë‹ˆë‹¤.<br/>
ë¬´ì¤‘ë‹¨ ë°°í¬ë¥¼ ìœ„í•´, ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ í¬íŠ¸ë„ í•¨ê»˜ ë³€ê²½í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.<br/>
ë”°ë¼ì„œ `8080, 18080` / `8081, 18081` ìœ¼ë¡œ ë¬¶ì–´ì„œ ê´€ë¦¬í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

ë§ˆì°¬ê°€ì§€ë¡œ Nginxì—ì„œ í¬íŠ¸ í¬ì›Œë”©ì„ ì²˜ë¦¬í•´ì¤ë‹ˆë‹¤.

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì´ ìˆìŠµë‹ˆë‹¤!!<br/>
Nginxì—ì„œ Actuatorì˜ í¬íŠ¸ë¥¼ í¬ì›Œë”©í•´ì£¼ê¸° ìœ„í•´ 18080 í¬íŠ¸ë¥¼ listení•˜ì—¬ ì ìœ í•˜ê²Œ ë©ë‹ˆë‹¤.<br/>
ì¦‰, Actuatorì˜ í¬íŠ¸ë¡œ 18080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ í¬íŠ¸ëŠ” `18081` ê³¼ `18082` ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ !

# ğŸ¤”Nginx ì„¤ì •

ì•„ë˜ëŠ” Nginx í¬íŠ¸ í¬ì›Œë”© ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

```bash
server {
  listen 443 ssl;
  server_name api.celuveat.com;

  ssl_certificate /etc/letsencrypt/live/api.celuveat.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.celuveat.com/privkey.pem;

  include /etc/nginx/conf.d/service-url.inc;
  location / {
    proxy_pass $service_url;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

server {
  listen 18080;
  include /etc/nginx/conf.d/service-url.inc;
  location / {
    proxy_pass $service_monitoring_url;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
```

# ğŸ¤”Github Actions Workflow

```bash
name: âœ¨ Celuveat backend PROD CD âœ¨

env:
  PROFILE: prod
  IMAGE_TAG: back-prod-${{ secrets.APP_VERSION_TAG }}
  DOCKER_CONTAINER_NAME: backend
  DOCKER_HUB_REPOSITORY: celuveat/celuveat
  SERVER_LOG_DIR_PATH: ~/log
  DOCKER_LOG_DIR_PATH: /app/logs

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  backend-docker-build-and-push:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: âœ¨ Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true
          token: ${{ secrets.ACTION_TOKEN }}

      - name: âœ¨ JDK 17 ì„¤ì •
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: âœ¨ Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: âœ¨ Gradlew ê¶Œí•œ ì„¤ì •
        run: chmod +x ./gradlew

      - name: âœ¨ Jar íŒŒì¼ ë¹Œë“œ
        run: ./gradlew bootJar

      - name: âœ¨ DockerHubì— ë¡œê·¸ì¸
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: âœ¨ Docker Image ë¹Œë“œ í›„ DockerHubì— Push
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/arm64
          tags: ${{ env.DOCKER_HUB_REPOSITORY }}:${{ env.IMAGE_TAG }}

  backend-docker-pull-and-run:
    runs-on: [self-hosted, prod]
    if: ${{ needs.backend-docker-build-and-push.result == 'success' }}
    needs: [ backend-docker-build-and-push ]
    steps:
      - name: âœ¨ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          export APP_VERSION_TAG=${{ secrets.APP_VERSION_TAG }}
          sh /home/ubuntu/deploy.sh
```
